// ÙØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡

class App {
    constructor() {
        this.authManager = authManager;
        this.vaultManager = vaultManager;
        this.crypto = clientCrypto;
        
        this.initializeApp();
    }

    initializeApp() {
        console.log('ðŸš€ Samsung Vault Web Application Initialized');
        
        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ†
        window.addEventListener('online', this.handleOnlineStatus.bind(this));
        window.addEventListener('offline', this.handleOfflineStatus.bind(this));
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§Ù‡Ø§ÛŒå…¨å±€
        window.addEventListener('error', this.handleGlobalError.bind(this));
        
        // Ù†Ù…Ø§ÛŒØ´ Ù†Ø³Ø®Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡
        this.showAppVersion();
    }

    handleOnlineStatus() {
        this.authManager.showNotification('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯', 'success');
        // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²
    }

    handleOfflineStatus() {
        this.authManager.showNotification('Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù‚Ø·Ø¹ Ø´Ø¯', 'error');
    }

    handleGlobalError(event) {
        console.error('Global error:', event.error);
        // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®Ø·Ø§Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ú¯Ø²Ø§Ø±Ø´ Ø¯Ù‡ÛŒØ¯
    }

    showAppVersion() {
        const version = '1.0.0';
        console.log(`ðŸ”’ Samsung Vault v${version}`);
        
        // Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù†Ø³Ø®Ù‡ Ø±Ø§ Ø¯Ø± Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒØ¯
        // document.getElementById('appVersion').textContent = `v${version}`;
    }

    // Ù…ØªØ¯Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒå…¨å±€
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    formatDate(date) {
        return new Date(date).toLocaleDateString('fa-IR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª session
    setupSessionManagement() {
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© ÙˆØ¶Ø¹ÛŒØª session
        setInterval(() => {
            this.authManager.verifyToken().then(valid => {
                if (!valid) {
                    this.authManager.showNotification('Session expired. Please login again.', 'error');
                    this.authManager.logout();
                }
            });
        }, 5 * 60 * 1000); // Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆÙ‚ØªÛŒ DOM Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯
document.addEventListener('DOMContentLoaded', () => {
    window.app = new App();
});

// Ù…ØªØ¯Ù‡Ø§ÛŒå…¨å±€ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² HTML
window.copyToClipboard = async (text) => {
    try {
        await navigator.clipboard.writeText(text);
        authManager.showNotification('Ù…ØªÙ† Ú©Ù¾ÛŒ Ø´Ø¯', 'success');
    } catch (err) {
        console.error('Failed to copy text: ', err);
        authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ†', 'error');
    }
};

window.generateStrongPassword = () => {
    const length = 16;
    const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?";
    let password = "";
    
    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø² Ù‡Ø± Ø¯Ø³ØªÙ‡
    password += "ABCDEFGHIJKLMNOPQRSTUVWXYZ".charAt(Math.floor(Math.random() * 26));
    password += "abcdefghijklmnopqrstuvwxyz".charAt(Math.floor(Math.random() * 26));
    password += "0123456789".charAt(Math.floor(Math.random() * 10));
    password += "!@#$%^&*()_+-=[]{}|;:,.<>?".charAt(Math.floor(Math.random() * 24));
    
    // ØªÚ©Ù…ÛŒÙ„ Ø¨Ù‚ÛŒÙ‡ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§
    for (let i = password.length; i < length; i++) {
        password += charset.charAt(Math.floor(Math.random() * charset.length));
    }
    
    // Ø¨Ù‡ Ù‡Ù… Ø²Ø¯Ù† ØªØ±ØªÛŒØ¨ Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§
    password = password.split('').sort(() => 0.5 - Math.random()).join('');
    
    return password;
};