class VaultManager {
    constructor() {
        this.baseURL = window.location.origin + '/api';
        this.currentTab = 'passwords';
        this.items = {};
        
        this.initializeEventListeners();
        this.loadInitialData();
    }

    initializeEventListeners() {
        // ØªØ¨â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.switchTab(e.currentTarget.dataset.tab);
            });
        });

        // Ù…Ù†ÙˆÛŒ Ú©Ù†Ø§Ø±ÛŒ
        document.querySelectorAll('.sidebar-menu').forEach(menu => {
            menu.addEventListener('click', (e) => {
                this.handleSidebarMenu(e.currentTarget.dataset.action);
            });
        });

        // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†
        document.getElementById('addPasswordBtn').addEventListener('click', () => {
            this.showAddPasswordModal();
        });
        
        document.getElementById('addNoteBtn').addEventListener('click', () => {
            this.showAddNoteModal();
        });
        
        document.getElementById('addCardBtn').addEventListener('click', () => {
            this.showAddCardModal();
        });
        
        document.getElementById('uploadFileBtn').addEventListener('click', () => {
            document.getElementById('fileUpload').click();
        });

        // Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
        document.getElementById('fileUpload').addEventListener('change', (e) => {
            this.handleFileUpload(e.target.files);
        });

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
        document.querySelector('.modal-close').addEventListener('click', () => {
            this.hideModal();
        });

        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                this.hideModal();
            }
        });
    }

    async loadInitialData() {
        if (!authManager.isLoggedIn()) return;

        try {
            await this.loadItems('passwords');
            await this.loadItems('files');
            await this.loadItems('notes');
            await this.loadItems('cards');
        } catch (error) {
            console.error('Error loading initial data:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§', 'error');
        }
    }

    switchTab(tabName) {
        // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ØªØ¨â€ŒÙ‡Ø§
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªØ¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}Tab`).classList.add('active');
        
        this.currentTab = tabName;
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ØªØ¨ Ø¬Ø§Ø±ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ù†Ø¯
        if (!this.items[tabName] || this.items[tabName].length === 0) {
            this.loadItems(tabName);
        }
    }

    async loadItems(type) {
        try {
            const response = await fetch(`${this.baseURL}/vault/items?type=${type}`, {
                headers: authManager.getHeaders()
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§');
            }

            const data = await response.json();
            this.items[type] = data.items;
            this.renderItems(type, data.items);
            
        } catch (error) {
            console.error(`Error loading ${type}:`, error);
            authManager.showNotification(`Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ${type}`, 'error');
        }
    }

    renderItems(type, items) {
        const container = document.getElementById(`${type}List`);
        
        if (!items || items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <p>Ù‡ÛŒÚ† ${this.getTypeName(type)}ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>
                    <button class="btn-primary" onclick="vaultManager.showAdd${this.capitalize(type)}Modal()">
                        Ø§ÙØ²ÙˆØ¯Ù† ${this.getTypeName(type)}
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = items.map(item => this.createItemCard(item, type)).join('');
    }

    createItemCard(item, type) {
        return `
            <div class="item-card" data-id="${item._id}">
                <div class="item-header">
                    <div class="item-title">${this.escapeHtml(item.title)}</div>
                    <div class="item-actions">
                        <button class="btn-icon" onclick="vaultManager.viewItem('${item._id}', '${type}')" title="Ù…Ø´Ø§Ù‡Ø¯Ù‡">
                            ğŸ‘ï¸
                        </button>
                        <button class="btn-icon" onclick="vaultManager.editItem('${item._id}', '${type}')" title="ÙˆÛŒØ±Ø§ÛŒØ´">
                            âœï¸
                        </button>
                        <button class="btn-icon" onclick="vaultManager.deleteItem('${item._id}', '${type}')" title="Ø­Ø°Ù">
                            ğŸ—‘ï¸
                        </button>
                        <button class="btn-icon" onclick="vaultManager.toggleFavorite('${item._id}', '${type}')" title="${item.favorite ? 'Ø­Ø°Ù Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§' : 'Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§'}">
                            ${item.favorite ? 'â­' : 'â˜†'}
                        </button>
                    </div>
                </div>
                <div class="item-meta">
                    <span class="item-category">${this.escapeHtml(item.category)}</span>
                    <span class="item-date">${new Date(item.createdAt).toLocaleDateString('fa-IR')}</span>
                </div>
                ${item.tags && item.tags.length > 0 ? `
                    <div class="item-tags">
                        ${item.tags.map(tag => `<span class="tag">${this.escapeHtml(tag)}</span>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }

    getTypeName(type) {
        const names = {
            'passwords': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
            'files': 'ÙØ§ÛŒÙ„',
            'notes': 'ÛŒØ§Ø¯Ø¯Ø§Ø´Øª',
            'cards': 'Ú©Ø§Ø±Øª'
        };
        return names[type] || type;
    }

    capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    showAddPasswordModal() {
        const modalContent = `
            <form id="addPasswordForm">
                <div class="form-group">
                    <label for="passwordTitle">Ø¹Ù†ÙˆØ§Ù†</label>
                    <input type="text" id="passwordTitle" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§ÛŒÙ…ÛŒÙ„ Ø¬ÛŒÙ…ÛŒÙ„" required>
                </div>
                <div class="form-group">
                    <label for="passwordUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
                    <input type="text" id="passwordUsername" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„">
                </div>
                <div class="form-group">
                    <label for="passwordValue">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <input type="password" id="passwordValue" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required>
                    <button type="button" class="btn-secondary" onclick="vaultManager.generatePassword()">ØªÙˆÙ„ÛŒØ¯ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
                </div>
                <div class="form-group">
                    <label for="passwordUrl">Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒØ³Ø§ÛŒØª</label>
                    <input type="url" id="passwordUrl" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="passwordCategory">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <select id="passwordCategory">
                        <option value="general">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                        <option value="social">Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ</option>
                        <option value="email">Ø§ÛŒÙ…ÛŒÙ„</option>
                        <option value="banking">Ø¨Ø§Ù†Ú©ÛŒ</option>
                        <option value="work">Ú©Ø§Ø±ÛŒ</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="vaultManager.hideModal()">Ù„ØºÙˆ</button>
                    <button type="submit" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        `;

        this.showModal('Ø§ÙØ²ÙˆØ¯Ù† Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯', modalContent);
        
        document.getElementById('addPasswordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveNewPassword();
        });
    }

    generatePassword() {
        const length = 12;
        const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
        let password = "";
        
        for (let i = 0; i < length; i++) {
            password += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        
        document.getElementById('passwordValue').value = password;
    }

    async saveNewPassword() {
        const title = document.getElementById('passwordTitle').value;
        const username = document.getElementById('passwordUsername').value;
        const password = document.getElementById('passwordValue').value;
        const url = document.getElementById('passwordUrl').value;
        const category = document.getElementById('passwordCategory').value;

        const passwordData = {
            username,
            password,
            url
        };

        try {
            // Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            const encryptedData = await clientCrypto.encryptData(JSON.stringify(passwordData));
            
            const response = await fetch(`${this.baseURL}/vault/items`, {
                method: 'POST',
                headers: {
                    ...authManager.getHeaders(),
                    'x-master-key': await this.getMasterKeyForRequest()
                },
                body: JSON.stringify({
                    type: 'password',
                    title,
                    data: encryptedData,
                    category
                })
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±');
            }

            authManager.showNotification('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
            this.hideModal();
            this.loadItems('passwords');
            
        } catch (error) {
            console.error('Error saving password:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±', 'error');
        }
    }

    async getMasterKeyForRequest() {
        // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§ÛŒØ¯ Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ø² storage ÛŒØ§ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¨Ú¯ÛŒØ±ÛŒÙ…
        // Ø§ÛŒÙ† ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª
        return 'default-master-key-hex-representation';
    }

    showAddNoteModal() {
        const modalContent = `
            <form id="addNoteForm">
                <div class="form-group">
                    <label for="noteTitle">Ø¹Ù†ÙˆØ§Ù†</label>
                    <input type="text" id="noteTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª" required>
                </div>
                <div class="form-group">
                    <label for="noteContent">Ù…Ø­ØªÙˆØ§</label>
                    <textarea id="noteContent" rows="6" placeholder="Ù…ØªÙ† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø´Ù…Ø§..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="noteCategory">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                    <select id="noteCategory">
                        <option value="general">Ø¹Ù…ÙˆÙ…ÛŒ</option>
                        <option value="personal">Ø´Ø®ØµÛŒ</option>
                        <option value="work">Ú©Ø§Ø±ÛŒ</option>
                        <option value="ideas">Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="vaultManager.hideModal()">Ù„ØºÙˆ</button>
                    <button type="submit" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        `;

        this.showModal('Ø§ÙØ²ÙˆØ¯Ù† ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¬Ø¯ÛŒØ¯', modalContent);
        
        document.getElementById('addNoteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveNewNote();
        });
    }

    async saveNewNote() {
        const title = document.getElementById('noteTitle').value;
        const content = document.getElementById('noteContent').value;
        const category = document.getElementById('noteCategory').value;

        const noteData = {
            content
        };

        try {
            const encryptedData = await clientCrypto.encryptData(JSON.stringify(noteData));
            
            const response = await fetch(`${this.baseURL}/vault/items`, {
                method: 'POST',
                headers: {
                    ...authManager.getHeaders(),
                    'x-master-key': await this.getMasterKeyForRequest()
                },
                body: JSON.stringify({
                    type: 'note',
                    title,
                    data: encryptedData,
                    category
                })
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª');
            }

            authManager.showNotification('ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
            this.hideModal();
            this.loadItems('notes');
            
        } catch (error) {
            console.error('Error saving note:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª', 'error');
        }
    }

    showAddCardModal() {
        const modalContent = `
            <form id="addCardForm">
                <div class="form-group">
                    <label for="cardTitle">Ø¹Ù†ÙˆØ§Ù†</label>
                    <input type="text" id="cardTitle" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©Ø§Ø±Øª Ø¨Ø§Ù†Ú© Ù…Ù„ÛŒ" required>
                </div>
                <div class="form-group">
                    <label for="cardNumber">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª</label>
                    <input type="text" id="cardNumber" placeholder="XXXX-XXXX-XXXX-XXXX" required>
                </div>
                <div class="form-group">
                    <label for="cardHolder">Ù†Ø§Ù… Ø¯Ø§Ø±Ù†Ø¯Ù‡ Ú©Ø§Ø±Øª</label>
                    <input type="text" id="cardHolder" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cardExpiry">ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</label>
                        <input type="text" id="cardExpiry" placeholder="MM/YY" required>
                    </div>
                    <div class="form-group">
                        <label for="cardCvv">CVV2</label>
                        <input type="text" id="cardCvv" placeholder="XXX" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="vaultManager.hideModal()">Ù„ØºÙˆ</button>
                    <button type="submit" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                </div>
            </form>
        `;

        this.showModal('Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Øª Ø¬Ø¯ÛŒØ¯', modalContent);
        
        document.getElementById('addCardForm').addEventListener('submit', (e) => {
            e.preventDefault();
            this.saveNewCard();
        });
    }

    async saveNewCard() {
        const title = document.getElementById('cardTitle').value;
        const cardNumber = document.getElementById('cardNumber').value;
        const cardHolder = document.getElementById('cardHolder').value;
        const expiry = document.getElementById('cardExpiry').value;
        const cvv = document.getElementById('cardCvv').value;

        const cardData = {
            cardNumber,
            cardHolder,
            expiry,
            cvv
        };

        try {
            const encryptedData = await clientCrypto.encryptData(JSON.stringify(cardData));
            
            const response = await fetch(`${this.baseURL}/vault/items`, {
                method: 'POST',
                headers: {
                    ...authManager.getHeaders(),
                    'x-master-key': await this.getMasterKeyForRequest()
                },
                body: JSON.stringify({
                    type: 'card',
                    title,
                    data: encryptedData,
                    category: 'banking'
                })
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Øª');
            }

            authManager.showNotification('Ú©Ø§Ø±Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'success');
            this.hideModal();
            this.loadItems('cards');
            
        } catch (error) {
            console.error('Error saving card:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ø±Øª', 'error');
        }
    }

    async handleFileUpload(files) {
        if (!files || files.length === 0) return;

        for (let file of files) {
            await this.uploadFile(file);
        }
    }

    async uploadFile(file) {
        try {
            // Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ ÙØ§ÛŒÙ„
            const encryptedFile = await clientCrypto.encryptFile(file);
            
            const formData = new FormData();
            formData.append('file', new Blob([encryptedFile.encryptedData]), file.name);
            formData.append('title', file.name);
            formData.append('category', 'files');

            const response = await fetch(`${this.baseURL}/files/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${authManager.token}`,
                    'x-master-key': await this.getMasterKeyForRequest(),
                    'x-file-iv': JSON.stringify(encryptedFile.iv)
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„');
            }

            authManager.showNotification(`ÙØ§ÛŒÙ„ "${file.name}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯`, 'success');
            this.loadItems('files');
            
        } catch (error) {
            console.error('Error uploading file:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„', 'error');
        }
    }

    async viewItem(itemId, type) {
        try {
            const response = await fetch(`${this.baseURL}/vault/items/${itemId}`, {
                headers: authManager.getHeaders()
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒØªÙ…');
            }

            const data = await response.json();
            this.showItemDetails(data.item, type);
            
        } catch (error) {
            console.error('Error viewing item:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢ÛŒØªÙ…', 'error');
        }
    }

    showItemDetails(item, type) {
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¨Ø§ÛŒØ¯ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢ÛŒØªÙ… Ø±Ø§ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡Ø¯
        // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø§Ø±Ø¯
        const modalContent = `
            <div class="item-details">
                <h4>${this.escapeHtml(item.title)}</h4>
                <p><strong>Ù†ÙˆØ¹:</strong> ${this.getTypeName(type)}</p>
                <p><strong>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ:</strong> ${this.escapeHtml(item.category)}</p>
                <p><strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</strong> ${new Date(item.createdAt).toLocaleDateString('fa-IR')}</p>
                ${item.tags && item.tags.length > 0 ? `
                    <p><strong>Ø¨Ø±Ú†Ø³Ø¨â€ŒÙ‡Ø§:</strong> ${item.tags.map(tag => this.escapeHtml(tag)).join(', ')}</p>
                ` : ''}
                <div class="detail-actions">
                    <button class="btn-secondary" onclick="vaultManager.hideModal()">Ø¨Ø³ØªÙ†</button>
                    <button class="btn-primary" onclick="vaultManager.editItem('${item._id}', '${type}')">ÙˆÛŒØ±Ø§ÛŒØ´</button>
                </div>
            </div>
        `;

        this.showModal('Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢ÛŒØªÙ…', modalContent);
    }

    async editItem(itemId, type) {
        // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…
        authManager.showNotification('Ù‚Ø§Ø¨Ù„ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
    }

    async deleteItem(itemId, type) {
        if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
            return;
        }

        try {
            const response = await fetch(`${this.baseURL}/vault/items/${itemId}`, {
                method: 'DELETE',
                headers: authManager.getHeaders()
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…');
            }

            authManager.showNotification('Ø¢ÛŒØªÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
            this.loadItems(type);
            
        } catch (error) {
            console.error('Error deleting item:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…', 'error');
        }
    }

    async toggleFavorite(itemId, type) {
        try {
            const response = await fetch(`${this.baseURL}/vault/items/${itemId}`, {
                method: 'PUT',
                headers: authManager.getHeaders(),
                body: JSON.stringify({
                    favorite: true // Ø§ÛŒÙ† Ø¨Ø§ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡Ø¯
                })
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ');
            }

            authManager.showNotification('ÙˆØ¶Ø¹ÛŒØª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯', 'success');
            this.loadItems(type);
            
        } catch (error) {
            console.error('Error toggling favorite:', error);
            authManager.showNotification('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒ', 'error');
        }
    }

    handleSidebarMenu(action) {
        switch (action) {
            case 'search':
                this.showSearchModal();
                break;
            case 'favorites':
                this.showFavorites();
                break;
            case 'settings':
                this.showSettings();
                break;
        }
    }

    showSearchModal() {
        const modalContent = `
            <div class="search-modal">
                <div class="form-group">
                    <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÙ…Ø§Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§..." autofocus>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        `;

        this.showModal('Ø¬Ø³ØªØ¬Ùˆ', modalContent);
        
        document.getElementById('searchInput').addEventListener('input', (e) => {
            this.performSearch(e.target.value);
        });
    }

    async performSearch(query) {
        if (!query || query.length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        try {
            const response = await fetch(`${this.baseURL}/vault/search?q=${encodeURIComponent(query)}`, {
                headers: authManager.getHeaders()
            });

            if (!response.ok) {
                throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ');
            }

            const data = await response.json();
            this.displaySearchResults(data.items);
            
        } catch (error) {
            console.error('Search error:', error);
        }
    }

    displaySearchResults(items) {
        const container = document.getElementById('searchResults');
        
        if (!items || items.length === 0) {
            container.innerHTML = '<p class="no-results">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</p>';
            return;
        }

        container.innerHTML = items.map(item => `
            <div class="search-result-item" onclick="vaultManager.viewItem('${item._id}', '${item.type}')">
                <div class="result-title">${this.escapeHtml(item.title)}</div>
                <div class="result-type">${this.getTypeName(item.type)}</div>
            </div>
        `).join('');
    }

    showFavorites() {
        // Ù†Ù…Ø§ÛŒØ´ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡
        this.switchTab('passwords'); // Ù…ÙˆÙ‚Øª
        authManager.showNotification('Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
    }

    showSettings() {
        const modalContent = `
            <div class="settings-modal">
                <h4>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ</h4>
                <div class="setting-item">
                    <label>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
                    <button class="btn-secondary" onclick="vaultManager.showChangePasswordModal()">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</button>
                </div>
                <div class="setting-item">
                    <label>Ø®Ø±ÙˆØ¬ Ø§Ø² ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</label>
                    <button class="btn-secondary" onclick="vaultManager.logoutAllDevices()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ù‡Ù…Ù‡ Ø¬Ø§</button>
                </div>
                <div class="setting-item">
                    <label>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</label>
                    <button class="btn-secondary" onclick="vaultManager.backupData()">Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                </div>
            </div>
        `;

        this.showModal('ØªÙ†Ø¸ÛŒÙ…Ø§Øª', modalContent);
    }

    showChangePasswordModal() {
        // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
        authManager.showNotification('Ù‚Ø§Ø¨Ù„ÛŒØª ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
    }

    logoutAllDevices() {
        // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§
        authManager.showNotification('Ù‚Ø§Ø¨Ù„ÛŒØª Ø®Ø±ÙˆØ¬ Ø§Ø² ØªÙ…Ø§Ù… Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
    }

    backupData() {
        // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ
        authManager.showNotification('Ù‚Ø§Ø¨Ù„ÛŒØª Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯', 'info');
    }

    showModal(title, content) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalBody').innerHTML = content;
        document.getElementById('modalOverlay').classList.add('active');
    }

    hideModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }
}

// Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù…ÙˆÙ†Ù‡ Ø§Ø² VaultManager Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§ÙˆØ¯ ØµÙØ­Ù‡
let vaultManager;
document.addEventListener('DOMContentLoaded', () => {
    vaultManager = new VaultManager();
});